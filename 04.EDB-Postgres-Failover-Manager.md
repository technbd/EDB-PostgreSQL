## EDB Postgres Failover Manager:


### Prerequisites:

_Before starting, ensure the following on all nodes:_
- **PostgreSQL or EDB Postgres Advanced Server** is installed on the master and standby nodes.
- **PostgreSQL streaming replication is configured** and running between the master and standby nodes. Same PG version & data directory path. 
- **Java 1.8 or later** is installed.
- **Network communication** is allowed through firewalls on the EFM port (default `7800-7810/tcp`).
- Time sync (chrony / ntpd)
- Passwordless SSH between nodes (for postgres user)
- `pg_hba.conf` is modified to allow communication between all nodes and the EFM user.
- An **EDB repository** is set up and configured on each server to access EFM packages. 



### Architecture:
- Witness: Prevents split-brain during network issues (strongly recommended).

| Server         | IP                 | Role                  | 
| -------------- | ------------------ | --------------------- | 
| **Primary DB** | **192.168.10.191** | EPAS Server + EFM     |
| **Standby DB** | **192.168.10.192** | EPAS Server + EFM     |
| **Witness**    | **192.168.10.193** | EPAS Client + EFM     |




---
---



## Installing EFM Server: (ALL 03 NODES)


_Installs EDB Failover Manager package:_
```
dnf install -y edb-efm40
```



```
cat /etc/passwd | grep efm

efm:x:1002:1002::/var/efm:/bin/bas
```



```
ll /usr/edb/efm-5.0/bin

-rwxr-xr-x 1 root root   386 Mar 20  2025 efm
-rwxr-xr-x 1 root root  2129 Mar 20  2025 efm_address
-rwxr-xr-x 1 root root 18029 Mar 20  2025 efm_db_functions
-rwxr-xr-x 1 root root  4669 Mar 20  2025 efm_pgpool_functions
-rwxr-xr-x 1 root root  2689 Mar 20  2025 efm_root_functions
-rwxr-xr-x 1 root root  1732 Mar 20  2025 runefm.sh
-rwxr-xr-x 1 root root  2881 Mar 20  2025 runJavaApplication.sh
drwxr-x--- 2 root efm     24 Jan 20 22:09 secure
```


```
ll /etc/edb/efm-5.0/

-rw-r--r-- 1 root root   139 Mar 20  2025 efm.nodes.in
-rw-r--r-- 1 root root 28998 Mar 20  2025 efm.properties.in
```





## Configure EFM: 


_All nodes:_
```
cd /etc/edb/efm-5.0/

cp efm.properties.in efm.properties
cp efm.nodes.in efm.nodes

chown efm:efm efm.properties
chown efm:efm efm.nodes

chmod 755 /etc/edb/efm-5.0

chmod 644 /etc/edb/efm-5.0/efm.properties
```




### Generate Encrypted Password: (Create Once)

```
/usr/edb/efm-5.0/bin/efm encrypt efm


This utility will generate an encrypted password for you to place in your
EFM cluster property file: /etc/edb/efm-5.0/efm.properties

Please enter the password and hit enter: <password>

Please enter the password again to confirm:

The encrypted password is: 216e5e5831a7eef69027f91ea89079e4

Please paste this into your efm.properties file
        db.password.encrypted=216e5e5831a7eef69027f91ea89079e4
```



### Change `enterprisedb` password: (Primary)

```
ALTER ROLE enterprisedb IDENTIFIED BY 'password';
```




### Create script notification file: (ALL 03 NODES)

_Edit file on `/etc/edb/efm-5.0/efm_notify.sh`:_
```
#!/bin/bash
echo "$(date) $*" >> /var/log/efm_notify.log
```


```
chmod +x efm_notify.sh
chown efm:efm efm_notify.sh
```





## On Primary (192.168.10.191): 

The configuration of efm consists of editing 2 main configuration files: `efm.nodes` and `efm.properties` :



#### Configure `efm.nodes` (Primary):


_Edit file on `/etc/edb/efm-5.0/efm.nodes`:_

```conf 

192.168.10.192:9998 192.168.10.193:9998
```



### Configure `efm.properties`: (Primary)


_Edit file on `/etc/edb/efm-5.0/efm.properties`:_

```conf 

db.user=enterprisedb
db.password.encrypted=216e5e5831a7eef69027f91ea89079e4
db.port=5444
db.database=edb

db.service.owner=enterprisedb
db.service.name=edb-as-16

db.bin=/usr/edb/as16/bin
db.data.dir=/var/lib/edb/as16/data
db.config.dir=/var/lib/edb/as16/data

jdbc.sslmode=disable

user.email=admin@technbd.local

script.notification=/etc/edb/efm-5.0/efm_notify.sh


bind.address=192.168.10.191:9998 
admin.port=7809

is.witness=false

local.period=10
local.timeout=60
local.timeout.final=10

remote.timeout=10
node.timeout=50

stop.isolated.primary=false

ping.server.ip=192.168.10.193
ping.server.command=/bin/ping -q -c3 -w5

auto.allow.hosts=true
stable.nodes.file=false

db.reuse.connection.count=0

auto.failover=true
auto.reconfigure=true
promotable=true

minimum.standbys=0       ## Allow automatic failover with single standby (NOT recommended in prod)
recovery.check.period=2

virtual.ip=
virtual.ip.interface=
virtual.ip.prefix=
virtual.ip.single=true

```






## On Standby (192.168.10.192): 


### Configure `efm.nodes` (Standby):


_Edit file on `/etc/edb/efm-5.0/efm.nodes`:_

```conf 

192.168.10.191:9998 192.168.10.193:9998
```



### Configure `efm.properties`: (Standby)

_Edit file on `/etc/edb/efm-5.0/efm.properties`:_

```conf 

db.user=enterprisedb
db.password.encrypted=216e5e5831a7eef69027f91ea89079e4
db.port=5444
db.database=edb

db.service.owner=enterprisedb
db.service.name=edb-as-16

db.bin=/usr/edb/as16/bin
db.data.dir=/var/lib/edb/as16/data
db.config.dir=/var/lib/edb/as16/data

jdbc.sslmode=disable

user.email=admin@technbd.local

script.notification=/etc/edb/efm-5.0/efm_notify.sh


bind.address=192.168.10.192:9998 
admin.port=7809

is.witness=false

local.period=10
local.timeout=60
local.timeout.final=10

remote.timeout=10
node.timeout=50

stop.isolated.primary=false

ping.server.ip=192.168.10.193
ping.server.command=/bin/ping -q -c3 -w5

auto.allow.hosts=true
stable.nodes.file=false

db.reuse.connection.count=0

auto.failover=true
auto.reconfigure=true
promotable=true

minimum.standbys=0       ## Allow automatic failover with single standby (NOT recommended in prod)
recovery.check.period=2

virtual.ip=
virtual.ip.interface=
virtual.ip.prefix=
virtual.ip.single=true

```





## On Witness (192.168.10.193): 



#### Configure `efm.nodes` (Witness):


_Edit file on `/etc/edb/efm-5.0/efm.nodes`:_

```conf 

192.168.10.191:9998 192.168.10.192:9998
```



### Configure `efm.properties` (Witness):


_Edit file on `/etc/edb/efm-5.0/efm.properties`:_

```conf


db.user=enterprisedb
db.password.encrypted=216e5e5831a7eef69027f91ea89079e4
db.port=5444
db.database=edb

db.service.owner=enterprisedb
db.service.name=edb-as-16

db.bin=/usr/edb/as16/bin
db.data.dir=/var/lib/edb/as16/data
db.config.dir=/var/lib/edb/as16/data

jdbc.sslmode=disable

user.email=admin@technbd.local

script.notification=/etc/edb/efm-5.0/efm_notify.sh


bind.address=192.168.10.193:9998 
admin.port=7809

is.witness=true   ## change false to true

local.period=10
local.timeout=60
local.timeout.final=10

remote.timeout=10
node.timeout=50

stop.isolated.primary=false

ping.server.ip=192.168.10.193
ping.server.command=/bin/ping -q -c3 -w5

auto.allow.hosts=true
stable.nodes.file=false

db.reuse.connection.count=0

auto.failover=true
auto.reconfigure=true
promotable=false   ## change true to false

minimum.standbys=0       ## Allow automatic failover with single standby (NOT recommended in prod)
recovery.check.period=2

virtual.ip=
virtual.ip.interface=
virtual.ip.prefix=
virtual.ip.single=true

```





## Modify `edb-efm-5.0.service` file: (ALL 03 NODES)

_Edit the file `/usr/lib/systemd/system/edb-efm-5.0.service`:_

```conf 

# Copyright EnterpriseDB Corporation, 2015-2025. All Rights Reserved.
#
# You should not modify the unit file in-place, because the file may be
# overwritten during package upgrades. See the Failover Manager documentation
# for more information.

[Unit]
Description=EnterpriseDB Failover Manager 5.0
Wants=network-online.target
After=network.target network-online.target

[Service]
Type=forking
TimeoutSec=120
Environment=CLUSTER=efm

User=root   ## Change user

PIDFile=/var/run/efm-5.0/efm.pid
SuccessExitStatus=143

ExecStart=/bin/bash -c "/usr/edb/efm-5.0/bin/runefm.sh start ${CLUSTER}"
ExecStop=/bin/bash -c "/usr/edb/efm-5.0/bin/runefm.sh stop ${CLUSTER}"

KillMode=process

[Install]
WantedBy=multi-user.target
```



_**To started on following order: Primary, Standby and Witness**:_

```
systemctl daemon-reload

systemctl start edb-efm-5.0
systemctl restart edb-efm-5.0
systemctl status edb-efm-5.0
```









## Verify: 

```
/usr/edb/efm-5.0/bin/efm cluster-status efm


### Output:

Cluster Status: efm

        Agent Type  Address              DB       VIP
        ----------------------------------------------------------------
        Primary     192.168.10.191       UP
        Standby     192.168.10.192       UP
        Witness     192.168.10.193       N/A

Allowed node host list:
        192.168.10.192 192.168.10.191 192.168.10.193

Membership coordinator: 192.168.10.191

Standby priority host list:
        192.168.10.192

Promote Status:

        DB Type     Address              WAL Received LSN   WAL Replayed LSN   Info
        ---------------------------------------------------------------------------
        Primary     192.168.10.191                          0/458D0B30
        Standby     192.168.10.192       0/458D0B30         0/458D0B30

        Standby database(s) in sync with primary. It is safe to promote.
```



## Switchover Scenario:

```
/usr/edb/efm-5.0/bin/efm promote efm -switchover
```


```
### Output:

Cluster Status: efm

        Agent Type  Address              DB       VIP
        ----------------------------------------------------------------
        Standby     192.168.10.191       UP
        Primary     192.168.10.192       UP
        Witness     192.168.10.193       N/A

Allowed node host list:
        192.168.10.191 192.168.10.192 192.168.10.193

Membership coordinator: 192.168.10.191

Standby priority host list:
        192.168.10.191

Promote Status:

        DB Type     Address              WAL Received LSN   WAL Replayed LSN   Info
        ---------------------------------------------------------------------------
        Primary     192.168.10.192                          0/4EA7A6C8
        Standby     192.168.10.191       0/4EA7A6C8         0/4EA7A6C8

        Standby database(s) in sync with primary. It is safe to promote.
```



## Failover Scenario:


### Manual promotion (recommended test):

_If you want to promote the standby manually:_
```
/usr/edb/efm-5.0/bin/efm promote efm


The primary database will be shut down and a standby will be promoted. Are you sure you want to continue? [y/N]: y
Would you like to attempt to promote the standby anyway [y/N]: y
Forcing this promotion may result in data loss - are you sure you want to continue? This is the last prompt. [y/N]: y
Promote command accepted by local agent. Proceeding with promotion. Run the 'cluster-status' command for information about the new cluster state.
```


### Auto-Failover:

Letâ€™s simulate a crash of our primary database by killing the corresponding process.

_On New primary (192.168.10.192):_
```
ps -ef | grep postgres


enterpr+  132294       1  0 15:40 ?        00:00:01 /usr/edb/as16/bin/edb-postgres -D /var/lib/edb/as16/data
enterpr+  132302  132294  0 15:40 ?        00:00:00 postgres: logger
enterpr+  132303  132294  0 15:40 ?        00:00:00 postgres: checkpointer
enterpr+  132304  132294  0 15:40 ?        00:00:00 postgres: background writer
enterpr+  150941  132294  0 16:48 ?        00:00:01 postgres: enterprisedb edb [local] idle
enterpr+  152334  132294  0 16:53 ?        00:00:00 postgres: walwriter
enterpr+  152335  132294  0 16:53 ?        00:00:00 postgres: autovacuum launcher
enterpr+  152336  132294  0 16:53 ?        00:00:00 postgres: dbms_aq launcher
enterpr+  152337  132294  0 16:53 ?        00:00:00 postgres: logical replication launcher
enterpr+  152339  132294  0 16:53 ?        00:00:00 postgres: walsender replicator 192.168.10.191(41046) streaming 0/4FC1B4B8
enterpr+  154076  132294  0 17:02 ?        00:00:00 postgres: enterprisedb edb 192.168.10.192(43420) idle
root      154098  110594  0 17:02 pts/0    00:00:00 grep --color=auto postgres
```



```
kill -9 132294
```



_Check log in our standby server (192.168.10.191):_
```
tail -f /var/log/efm-5.0/efm.log
```


_Check cluster status:_
```
/usr/edb/efm-5.0/bin/efm cluster-status efm


Cluster Status: efm

        Agent Type  Address              DB       VIP
        ----------------------------------------------------------------
        Primary     192.168.10.191       UP
        Idle        192.168.10.192       UNKNOWN
        Witness     192.168.10.193       N/A

Allowed node host list:
        192.168.10.191 192.168.10.192 192.168.10.193

Membership coordinator: 192.168.10.191

Standby priority host list:
        (List is empty.)

Promote Status:

        DB Type     Address              WAL Received LSN   WAL Replayed LSN   Info
        ---------------------------------------------------------------------------
        Primary     192.168.10.191                          0/504EDF70

        No standby databases were found.

Idle Node Status (idle nodes ignored in WAL LSN comparisons):

        Address              WAL Received LSN   WAL Replayed LSN   Info
        ---------------------------------------------------------------
        192.168.10.192       UNKNOWN            UNKNOWN            Connection to 192.168.10.192:5444 refused. Check that the hostname and port are correct and that the postmaster is accepting TCP/IP connections.

```






### Check Old primary (192.168.10.192):

On the old primary (192.168.10.192) we can see the contents of the file `recovery.conf` automatically created by EDB Failover manager. If need rebuild standby database we have to edit the `recovery.conf` file. 


```
cat recovery.conf


# EDB Failover Manager
# This generated recovery.conf file prevents the db server from accidentally
# being restarted as a primary since a failover or promotion has occurred.
# For v12 and above the settings are ignored; the presence of the file
# prevents startup.
standby_mode = on
restore_command = 'echo 2>"recovery suspended on failed server node"; exit 1'
```





### Ref: 
- [Creating a Failover Manager cluster](https://www.enterprisedb.com/docs/efm/latest/efm_quick_start/)
- [EDB Failover Manager](https://www.dbi-services.com/blog/edb-failover-manager-3-0-and-postgresql-10-1/)




